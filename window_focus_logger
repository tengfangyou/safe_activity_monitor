#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
window_focus_logger.py

只記錄「前景視窗切換」：
- 視窗標題、PID、Process Name、時間戳
- 每次前景視窗(視窗標題或 PID)變更時才寫入
- 不記錄背景 process 事件、不記錄 IDLE

依賴：
  pip install pywinctl psutil
"""

import time
import argparse
from pathlib import Path
from datetime import datetime
import psutil

try:
    import pywinctl as pwc
except Exception:
    pwc = None

DEFAULT_POLL = 0.5      # 每 0.5 秒輪詢一次前景視窗
DEFAULT_DEBOUNCE = 0.2  # 去彈跳秒數：變更需穩定超過此值才記錄(避免抖動)
LOG_DIR_DEFAULT = "logs"

def now_str():
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

def daily_log_path(base_dir: Path) -> Path:
    day = datetime.now().strftime("%Y-%m-%d")
    return base_dir / f"focus_{day}.txt"

def get_active_window():
    """回傳 (title, pid, pname)。失敗時 title='Unknown Window'。"""
    title, pid, pname = "Unknown Window", None, None
    if pwc is None:
        return title, pid, pname
    try:
        w = pwc.getActiveWindow()
        if not w:
            return title, pid, pname
        title = w.title or "Untitled"
        pid = w.getPid() if hasattr(w, "getPid") else None
        if pid:
            try:
                pname = psutil.Process(pid).name()
            except Exception:
                pname = None
        return title, pid, pname
    except Exception:
        return title, pid, pname

def write_line(path: Path, line: str):
    path.parent.mkdir(parents=True, exist_ok=True)
    with open(path, "a", encoding="utf-8") as f:
        f.write(line + "\n")

def main():
    ap = argparse.ArgumentParser(description="Log only foreground window changes (Not a keylogger).")
    ap.add_argument("--dir", default=LOG_DIR_DEFAULT, help="log 目錄（預設 logs）")
    ap.add_argument("--poll", type=float, default=DEFAULT_POLL, help="輪詢秒數（預設 0.5）")
    ap.add_argument("--debounce", type=float, default=DEFAULT_DEBOUNCE, help="去彈跳秒數（預設 0.2）")
    args = ap.parse_args()

    if pwc is None:
        print("警告：pywinctl 未可用，無法抓前景視窗。請先安裝：pip install pywinctl")
        return

    base = Path(args.dir).expanduser().resolve()
    last = {"title": None, "pid": None, "pname": None}
    pending_change = None  # (title, pid, pname, first_seen_ts)

    print(f"[INFO] 只記錄前景視窗切換。log 目錄: {base}  poll={args.poll}s  debounce={args.debounce}s")
    try:
        while True:
            title, pid, pname = get_active_window()
            cur = (title, pid, pname)

            # 第一筆直接記一次
            if last["title"] is None and title is not None:
                logf = daily_log_path(base)
                write_line(logf, f"[{now_str()}] FOCUS title={title} pid={pid or ''} name={pname or ''}")
                last.update({"title": title, "pid": pid, "pname": pname})
                pending_change = None

            # 與上一筆不同 => 準備記錄，但先等 debounce 穩定
            elif (last["title"], last["pid"], last["pname"]) != cur:
                now = time.time()
                if pending_change is None:
                    pending_change = (title, pid, pname, now)
                else:
                    _, _, _, first_seen = pending_change
                    # 變更持續超過 debounce，才寫檔
                    if now - first_seen >= args.debounce:
                        logf = daily_log_path(base)
                        write_line(logf, f"[{now_str()}] FOCUS title={title} pid={pid or ''} name={pname or ''}")
                        last.update({"title": title, "pid": pid, "pname": pname})
                        pending_change = None
            else:
                # 沒變化，清掉 pending
                pending_change = None

            time.sleep(args.poll)

    except KeyboardInterrupt:
        print("Bye.")

if __name__ == "__main__":
    main()
